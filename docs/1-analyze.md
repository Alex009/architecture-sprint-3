# Описание функциональности текущего приложения

Текущая система - монолитное приложение, которое выполняет следующие основные функции:

1. Управление отоплением:
    1. Пользователи могут удаленно включать и выключать систему отопления в своих домах.
    2. Пользователи могут устанавливать целевую температуру для системы отопления.
    3. Пользователи могут получать текущую температуру системы отопления.
2. Мониторинг температуры:
    1. Система получает данные о текущей температуре с датчиков, установленных в домах пользователей.
    2. Пользователи могут просматривать текущую температуру в своих домах через внешний веб-интерфейс.

Следует выделить следующие особенности:

1. Нет механизма авторизации пользователей - вся API доступна всем
2. Нет самого понятия "пользователь", есть только системы отопления и сенсоры.
3. Нет связей между сенсорами и системами отопления - это отдельные сущности которые никак не влияют друг на друга.

# Анализ архитектуры монолитного приложения

Текущая архитектура системы имеет следующие характеристики:

1. Язык программирования - Java.
2. База данных - PostgreSQL.
3. Архитектура - монолит, вся система в одном Spring приложении с одной PSQL базой данных.
4. Взаимодействие - REST API, запросы обрабатываются синхронно, клиент получает конечный результат операции в ответ на
   запрос.
5. Масштабируемость:
    1. Вертикальное масштабирование - можем добавлять больше ресурсов, для увеличения производительности системы.
    2. Горизонтальное масштабирование:
        1. Судя по реализации сервис stateless, а значит мы можем добавить балансировщик и поднять несколько вариантов
           этого сервиса, они не должны друг другу мешать.
        2. Также судя по реализации можно добавить шардирование для базы данных по ключу в виде ID системы/сенсора - все
           запросы работают с конкретной записью, а значит шардирование по ключу не приведет к дополнительным затратам.
6. Развертывание - для проекта сделан Dockerfile, что позволяет использовать контейнеризацию при развертывании. За счет
   stateless реализации мы можем реализовать мягкую замену сервиса (blue-green), при которой сначала трафик будет идти
   на старую
   версию, пока поднимается новая, а дальше уже переключится трафик на новую версию. Однако это нужно делать руками,
   ведь сейчас в проекте нет готовых скриптов либо конфигурации Kuber под это.

# Определение доменов и границ контекстов в системе

Сейчас система сделана под локальное применение для систем отопления, а в планах сильное масштабирование в плане
пользовательской базы, географии и доступного функционала - пользователи смогут сами подключать и настраивать
устройства, устройств и сенсоров станет множество (не только система отопления и датчик температуры). Поэтому я описал
два варианта домена и контекстов - как есть сейчас и к чему планируем прийти.

## Как есть сейчас

### Домен "Управление системами отопления"

Вся функциональность сосредоточена вокруг одного типа устройства — системы отопления.

Основные функции:

1. Включение и выключение системы отопления.
2. Установка целевой температуры.

Границы контекста:  
Включает все аспекты управления системой отопления. Взаимодействие с пользователями или другими системами не
предусмотрено.

### Домен "Мониторинг температуры"

Этот домен отвечает за сбор и предоставление данных о температуре, получаемых с датчиков, установленных в домах.

Основные функции:

1. Получение текущих данных о температуре.
2. Отправка данных о температуре в систему отопления для регулирования работы.

Границы контекста:
Включает работу только с датчиками температуры. Другие виды устройств и данные от них не поддерживаются.

### Домен "Пользовательский интерфейс"

Веб сайты, которые используют пользователи для работы с системой - просмотру температуры и управлением своей системой
отопления. Данные вебсайты разрабатываются сторонней организацией, но являются важным элементом бизнес системы, ведь без
них пользователи не смогут пользоваться нашей системой. Если бы вебсайты разрабатывались нашей же организацией - они
были бы частью других доменов, а не самостоятельным.

Границы контекста:
Включает работу вебсайтов и их взаимодействие с API нашей системы.

### Взаимосвязи

Домен "Управление системами отопления" связан с доменом "Мониторинг температуры" только получением информации о текущей
температуре для регуляции активности отопительной системы. (Хотя по коду реализации сенсоры вообще не реализованы и не
имеют API, но описание "текущего состояния" в задании говорит что сейчас эта механика работает. Поэтому пофантазировал
что это будто бы есть уже).

## Как планируется

Планируется сделать SAAS систему с возможностью подключения различных внешних устройств самостоятельно пользователями в
разных регионах. А значит нужно расположить региональные сервера и дом пользователя будет привязан к конкретному
региональному серверу, ведь дом не может переместиться.

Для активного масштабирования функционала и поддержки различных типов устройств планируется разделить систему на
микросервисы, чтобы понизить сложность системы для разработки конкретных функций. Далее описаны домены, в пределах
которых команды будут делать 1 или несколько микросервисов. Если оставить монолит как есть, то наращивание функций
начнет тормозить разработку из-за связанности и отсутствия разделения ответственности команд.

В целом можно было бы в пределах монолита разделить систему на отдельные модули, за каждый из которых отвечала бы своя
команда, а взаимодействие между модулями регулировалось через согласование API программных интерфейсов. Но в таком
случае масштабирование под нагрузку будет осложнено - ради усиления узкого места, например получения данных телеметрии,
придется поднимать дополнительные инстансы большого монолита, а значит часть ресурсов будут расходоваться зазря. А также
при росте кодовой базы монолита будет сложно проконтролировать что система остается stateless и мы можем потерять
возможность горизонтального масштабирования всей системы целиком. В случае с микросервисами мы сможем выделять statefull
сервисы отдельно, а остальные держать stateless и их масштабировать.

### Домен "Пользователи"

Система теперь будет работать в режиме SAAS, поэтому нам нужны пользователи и привязка данных к пользователям.

Функции:

1. Регистрация
2. Авторизация

Границы контекста: домен пользователей ограничен процессом регистрации и авторизации, а всё что дальше может делать
пользователь - другие домены.

### Домен "Уведомления"

Системе потребуется взаимодействие с пользователями через различные механизмы уведомлений - письмо на почту с
информацией для регистрации, смс о результате работы автоматизации.

Функции:

1. Отправка емейл
2. Отправка смс

Границы контекста: включено в контекст только предоставление транспорта для уведомления пользователей - емейлы, смс.
Никакой связи с другими доменами нет.

### Домен "Управление домами"

Пользователи получают SAAS платформу и возможность добавлять свои собственные устройства, без выезда специалистов.
Устройства связаны с домами, поэтому для удобства управления и настройки в дальнейшем сценариев вводим домен домов.

Функции:

1. Создание/редактирование/удаление дома
2. Настройка доступа к дому (приглашение других пользователей и удаление из доступа)
3. Предоставление уровня доступа пользователя к дому
4. Предоставление информации о наличии доступа пользователя к дому (для других сервисов)

Границы контекста: домен работает только с авторизованными пользователями, ограничивается управлением сущностью дом и
доступ к дому. Устройства не входят в данный домен.

### Домен "Интеграция устройств"

В данный домен входит интеграция разных типов устройств с нашей системой - создание сервисов-адаптеров под каждый
протокол устройства. В ответственность данного домена входит предоставление стандартизированного единого API работы с
устройствами внутри системы.

На этапе MVP поддерживать будем текущие системы отопления и датчики температуры, а дальше сможем наращивать
поддерживаемые устройства добавляя новые микросервисы-адаптеры для поддержки новых протоколов.

Границы контекста: техническое взаимодействие с устройствами и стандартизация API для работы с ними самой системы.
Изменение настроек, чтение данных, получение обновлений с устройств, передача в шину событий нашей системы всех
обновлений и применение изменений читая из шины событий.

### Домен "Управление устройствами"

Включает управление всеми устройствами в умном доме, такими как система отопления, освещение, ворота и другие
модули умного дома.

Функции:

1. Добавление/удаление устройства (с привязкой к дому)
2. Управление (чтение и изменение) настройками
3. Отправка команд устройству
4. Удаление всех устройств при удалении дома

Границы контекста: в контекст данного домена входит авторизованный пользователь, созданный дом, уровень доступа
пользователя к дому (а значит и к устройствам этого дома), всё управление устройствами, рассматриваемыми в общем виде,
как некоторые абстрактные устройства которые можно включить, выключить, прочитать настройки, записать настройки. Более
точная работа с устройствами, например "трансляция IP камеры" не входит в данный домен, однако в данный домен входит
"включить/выключить камеру" и "настроить куда передавать данные с камеры".

### Домен "Телеметрия"

Включает получение и хранение всех данных с устройств-датчиков и предоставление доступа на чтение этих данных.

Функции:

1. Чтение с датчиков данных
2. Сохранение в базу данных
3. Предоставление исторических данных для пользователя
4. Удаление данных при удалении устройства

Границы контекста: в контекст данного домена входит авторизованный пользователь, созданное устройство, уровень доступа к
устройству, получение данных с устройств, обработка, хранение и выдача этой информации пользователям имеющим доступ.

### Домен "Автоматизация"

В целевой системе пользователи должны иметь возможность настраивать собственные сценарии работы собственных устройств,
например "когда температура опустится до 20 градусов - включить отопительную систему", либо "в полночь включить свет".

Ответственность в данном домене только за управление и выполнение сценариев. В данном домене рассматривается получение
событий (новая телеметрия например) и отправка команд управления как черный ящик - реальная реализация делегирована в
соответствующие домены.

Функции:

1. Управление сценариями работы
2. Выполнение сценариев (чтение данных с телеметрии и отправка команд в сервис управления устройствами)

Границы контекста: в контекст данного домена входит авторизованный пользователь, созданный дом, уровень доступа
пользователя к дому (а значит и к устройствам этого дома), созданное устройство, создание,изменение и удаление сценариев
работы, прослушивание телеметрии и других триггеров (например планирование по времени либо реакция на действие
пользователя в интерфейсе), отправка команд на исполнение действий сценариев.

### Домен "Пользовательский интерфейс"

Также как и в текущем состоянии системы вебсайты которыми пользуются конечные пользователи передаются на аутсорс и
являются отдельным доменом для нас.

### Взаимодействие доменов

Все домены связаны с доменом авторизации - опираются на факт предварительной авторизации пользователя.
Домен управления устройствами связан с управлением домами - устройства привязываются к домам и доступ к ним
предоставляется при наличии доступа к дому.
Домен телеметрии связан с управлением устройствами - телеметрия привязана к устройству и доступ предоставляется только
при наличии доступа к устройству (вместо транзитивной зависимости до "доступ к дому" выбран путь зависимости от
"управления устройствами", на случай если в будущем можно будет выдавать доступ пользователю к конкретному устройству.
Домен автоматизации связан с доменами управления устройствами и телеметрии - автоматизация опирается на данные с
телеметрии и отправляет команды устройствам, а также опирается на уровень доступа к устройствам. Также домен связан с
доменом дом, так как привязка сценария автоматизации производится к дому в целом и доступ к всему сценарию получают
пользователи имеющие доступ к дому.

# C4 диаграмма контекста

Диаграмма визуализирует взаимодействие текущего монолитного приложения с внешними системами и пользователями. Основные
элементы диаграммы:

1. Владелец дома: Пользователь системы, который взаимодействует с ней через веб-интерфейс.
2. Веб-интерфейс: Внешняя система, через которую пользователь отправляет запросы на управление системой
   отопления.
3. Система отопления: Основное монолитное приложение, которое управляет отоплением и мониторингом
   температуры.
4. Датчики температуры: Внешние устройства, которые передают данные в систему отопления.

Просмотреть диаграмму можно в файле [1-c4-context.puml](1-c4-context.puml)
